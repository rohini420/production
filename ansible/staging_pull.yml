- hosts: staging
  become: yes
  gather_facts: false
  vars:
    image: ""   # e.g. ghcr.io/OWNER/REPO/employee-dir
    tag: ""     # e.g. 42
    container_name: app_staging

  pre_tasks:
    # Make sure Python exists so Ansible modules can run (runs even if Python is missing)
    - name: Ensure Python 3 is present (bootstrap)
      raw: test -e /usr/bin/python3 || (apt-get update -y && apt-get install -y python3)
      changed_when: false

    # Now that Python exists, collect facts
    - name: Gather facts
      setup:

  tasks:
    - name: Ensure Docker, Nginx, Python Docker SDK
      apt:
        name: [docker.io, nginx, python3-docker]
        state: present
        update_cache: yes

    - name: Pull image
      community.docker.docker_image:
        name: "{{ image }}"
        tag: "{{ tag }}"
        source: pull

    - name: Remove old container (if any)
      community.docker.docker_container:
        name: "{{ container_name }}"
        state: absent
      ignore_errors: true

    - name: Run staging container on localhost:{{ app_port }}
      community.docker.docker_container:
        name: "{{ container_name }}"
        image: "{{ image }}:{{ tag }}"
        state: started
        restart_policy: always
        published_ports:
          - "127.0.0.1:{{ app_port }}:8000"
        env:
          DJANGO_SETTINGS_MODULE: employee_directory.settings
          SECRET_KEY: "{{ django_secret_key | default('changeme') }}"

    - name: Wait for app
      uri:
        url: "http://127.0.0.1:{{ app_port }}/"
        status_code: 200
      register: _h
      retries: 20
      delay: 2
      until: _h.status == 200

    - name: Configure Nginx reverse proxy
      copy:
        dest: /etc/nginx/conf.d/employee.conf
        content: |
          upstream app_upstream { server 127.0.0.1:{{ app_port }}; }
          server {
            listen 80;
            server_name {{ domain_name | default('_') }};
            server_tokens off;
            location / {
              proxy_pass http://app_upstream;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            }
          }

    - name: Disable default site
      file: { path: /etc/nginx/sites-enabled/default, state: absent }

    - name: Test & reload nginx
      command: nginx -t
      register: test
      changed_when: false

    - debug: { var: test.stderr_lines }

    - service: { name: nginx, state: reloaded }

